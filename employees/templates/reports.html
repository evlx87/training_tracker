{% extends 'base.html' %}
{% load dict_get %}

{% block title %}
Отчет по обучению
{% endblock %}

{% block content %}
<h1>Отчет по обучению</h1>

<!-- Сводка статистики -->
<div class="report-summary">
    <p>Всего сотрудников: {{ total_employees }}</p>
    <!-- Столбчатая диаграмма -->
    <div class="chart-container">
        <table class="bar-chart">
            <tr>
                {% for program, trained_count in trained_counts.items %}
                <td>
                    <div class="bar" style="height: {{ trained_count|add:10 }}px;" title="{{ program }}: {{ trained_count }}"></div>
                    <span>{{ program }}</span>
                </td>
                {% endfor %}
            </tr>
        </table>
    </div>
</div>

<!-- Фильтры и поиск -->
<div class="filters-container">
    <form method="get" class="filter-form">
        <div class="form-group">
            <label for="employees">Сотрудники:</label>
            <select name="employees" id="employees" class="form-input" multiple>
                <option value="" {% if not selected_employees %}selected{% endif %}>Все сотрудники</option>
                {% for employee in employees %}
                <option value="{{ employee.pk }}" {% if employee.pk|stringformat:"s" in selected_employees %}selected{% endif %}>
                    {{ employee.last_name }} {{ employee.first_name.0 }}.{% if employee.middle_name %}{{ employee.middle_name.0 }}.{% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="program">Программа обучения:</label>
            <select name="program" id="program" class="form-input">
                <option value="" {% if not selected_program %}selected{% endif %}>Все программы</option>
                {% for program in training_programs %}
                <option value="{{ program.id }}" {% if program.id|stringformat:"s" == selected_program %}selected{% endif %}>
                    {{ program.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <button type="submit" class="button button--primary">Применить</button>
            <a href="{% url 'employees:reports' %}" class="button button--danger">Сбросить</a>
            <a href="{% url 'employees:export_report' %}" class="button button--success">Экспорт в Excel</a>
        </div>
    </form>
</div>

<!-- Легенда -->
<div class="legend">
    <div class="legend-item not-completed">Не пройдено <span class="icon">✖</span></div>
    <div class="legend-item overdue">Просрочено <span class="icon">⏰</span></div>
    <div class="legend-item warning">Скоро истекает <span class="icon">⚠</span></div>
    <div class="legend-item completed">Пройдено <span class="icon">✔</span></div>
</div>

<!-- Таблица отчета -->
<div class="table-container">
    <table class="report-table">
        <thead>
            <tr>
                <th>Сотрудник</th>
                <th>Должность</th>
                <th>Подразделение</th>
                {% if selected_program %}
                <th>{{ selected_program_name }}</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for data in report_data %}
            <tr class="employee-row">
                <td>{{ data.employee.last_name }} {{ data.employee.first_name.0 }}. {% if data.employee.middle_name %}{{ data.employee.middle_name.0 }}.{% endif %}</td>
                <td>{{ data.employee.position|default:"—" }}</td>
                <td>{{ data.employee.department|default:"—" }}</td>
                {% if selected_program %}
                    {% with training_status=data.trainings|int_key:selected_program %}
                    <td class="{{ training_status|dict_get:'class'|default:'not-completed' }}"
                        title="{{ training_status|dict_get:'details'|default:'' }}">
                        {% if training_status and training_status.date != "Обучение не пройдено" %}
                            {{ training_status.date|date:"d.m.y" }}
                            <span class="icon">{{ training_status.class|get_status_icon }}</span>
                        {% else %}
                            <span class="icon">✖</span>
                        {% endif %}
                    </td>
                    {% endwith %}
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">Данные не найдены.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.getElementById('employees').addEventListener('change', function() {
    const options = this.options;
    const allEmployeesOption = options[0];
    if (allEmployeesOption.selected) {
        for (let i = 1; i < options.length; i++) {
            options[i].selected = false;
        }
    } else if (this.selectedOptions.length > 0) {
        allEmployeesOption.selected = false;
    }
});
</script>
{% endblock %}