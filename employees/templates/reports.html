{% extends 'base.html' %}
{% load dict_get %}

{% block title %}
Отчет по обучению
{% endblock %}

{% block content %}
<h1>Отчет по обучению</h1>

<!-- Сводка статистики -->
<div class="report-summary">
    <p>Всего сотрудников: {{ employees|length }}</p>
    <p>Завершено обучений: {{ completed_trainings }} ({{ completed_percentage }}%)</p>
</div>

<!-- Фильтры и поиск -->
<div class="filters-container">
    <form method="get" class="filter-form">
        <div class="form-group">
            <label for="department">Подразделение:</label>
            <select name="department" id="department" class="form-input">
                <option value="">Все подразделения</option>
                {% for dept in departments %}
                <option value="{{ dept.pk }}" {% if dept.pk|stringformat:"s" == request.GET.department %}selected{% endif %}>
                    {{ dept.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="search">Поиск по имени:</label>
            <input type="text" name="search" id="search" class="form-input" value="{{ request.GET.search|default:"" }}" placeholder="Введите ФИО">
        </div>
        <div class="form-group">
            <button type="submit" class="button button--primary">Применить</button>
            <a href="{% url 'employees:reports' %}" class="button button--danger">Сбросить</a>
            <!-- Кнопка экспорта -->
            <a href="{% url 'employees:export_report' %}" class="button button--success">Экспорт в Excel</a>
        </div>
    </form>
</div>

<!-- Легенда -->
<div class="legend">
    <div class="legend-item not-completed">Не пройдено <span class="icon">✖</span></div>
    <div class="legend-item overdue">Просрочено <span class="icon">⏰</span></div>
    <div class="legend-item warning">Скоро истекает <span class="icon">⚠</span></div>
    <div class="legend-item completed">Пройдено <span class="icon">✔</span></div>
</div>

<!-- Таблица отчета -->
<div class="table-container">
    <table class="report-table">
        <thead>
            <tr>
                <th>Сотрудник</th>
                <th>Должность</th>
                <th>Подразделение</th>
                {% for program in training_programs %}
                <th title="{{ program.name }}" class="sortable" data-program-id="{{ program.id }}">
                    {{ program.name|truncatechars:15 }}
                    <span class="sort-icon"></span>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for data in report_data %}
            <tr class="employee-row" data-employee-id="{{ data.employee.pk }}">
                <td>{{ data.employee.last_name }} {{ data.employee.first_name|first }}. {% if data.employee.middle_name %}{{ data.employee.middle_name|first }}.{% endif %}</td>
                <td>{{ data.employee.position|default:"—" }}</td>
                <td>{{ data.employee.department|default:"—" }}</td>
                {% for program in training_programs %}
                <td class="{{ data.trainings|get_item:program.id|get_item:'class' }}" title="{{ data.trainings|get_item:program.id|get_item:'details' }}">
                    {% with training_status=data.trainings|get_item:program.id %}
                    {% if training_status.date == "Обучение не пройдено" %}
                        {% if training_status.class == "not-completed" %}<span class="icon">✖</span>{% endif %}
                    {% else %}
                        {{ training_status.date|date:"d.m.y" }}
                        {% if training_status.class == "overdue" %}<span class="icon">⏰</span>{% endif %}
                        {% if training_status.class == "warning" %}<span class="icon">⚠</span>{% endif %}
                        {% if training_status.class == "completed" %}<span class="icon">✔</span>{% endif %}
                    {% endif %}
                    {% endwith %}
                </td>
                {% endfor %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ training_programs|length|add:3 }}">Нет данных для отображения.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- JavaScript для интерактивности -->
<script>
    // Сортировка таблицы
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const programId = this.getAttribute('data-program-id');
            const url = new URL(window.location);
            url.searchParams.set('sort_by', programId);
            url.searchParams.set('sort_order', url.searchParams.get('sort_order') === 'asc' ? 'desc' : 'asc');
            window.location = url;
        });
    });

    // Сворачивание/разворачивание строк
    document.querySelectorAll('.employee-row').forEach(row => {
        row.addEventListener('click', function(e) {
            if (e.target.tagName !== 'A' && !e.target.closest('.sortable')) {
                this.classList.toggle('collapsed');
            }
        });
    });
</script>

{% endblock %}