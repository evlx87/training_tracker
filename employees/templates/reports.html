{% extends 'base.html' %}
{% load dict_get %}

{% block title %}
Отчет по обучению
{% endblock %}

{% block content %}
<h1>Отчет по обучению</h1>
<div class="form-group">
    <a href="{% url 'employees:index' %}" class="button button--danger">На главную</a>
    <form action="{% url 'employees:training_record_create' %}" method="post" class="form-container">
        {% csrf_token %}
        <div class="form-group">
            <label for="employee_pk">Сотрудник:</label>
            <select name="employee_pk" id="employee_pk" class="form-input" required>
                <option value="">Выберите сотрудника</option>
                {% for employee in employees %}
                <option value="{{ employee.pk }}">{{ employee.last_name }} {{ employee.first_name }} {{ employee.middle_name }}</option>
                {% endfor %}
            </select>
            {% if form.errors.employee_pk %}
            <div class="messages error">{{ form.errors.employee_pk }}</div>
            {% endif %}
        </div>
        <button type="submit" class="button button--success">Добавить запись</button>
    </form>
</div>
<div class="legend">
    <div class="legend-item not-completed">Не пройдено</div>
    <div class="legend-item overdue">Просрочено</div>
    <div class="legend-item warning">Скоро истекает</div>
    <div class="legend-item completed">Пройдено</div>
</div>
<div class="table-container">
    <table class="report-table">
        <thead>
            <tr>
                <th>Сотрудник</th>
                <th>Должность</th>
                <th>Подразделение</th>
                {% for program in training_programs %}
                <th title="{{ program.name }}">{{ program.name|truncatechars:10 }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for data in report_data %}
            <tr>
                <td>{{ data.employee.last_name }} {{ data.employee.first_name|first }}. {% if data.employee.middle_name %}{{ data.employee.middle_name|first }}.{% endif %}</td>
                <td>{{ data.employee.position|default:"—" }}</td>
                <td>{{ data.employee.department|default:"—" }}</td>
                {% for program in training_programs %}
                <td class="{{ data.trainings|get_item:program.id|get_item:'class' }}">
                    {% with training_status=data.trainings|get_item:program.id %}
                    {% if training_status.date == "Обучение не пройдено" %}
                        —
                    {% else %}
                        {{ training_status.date|date:"d.m.y" }}
                    {% endif %}
                    {% endwith %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}