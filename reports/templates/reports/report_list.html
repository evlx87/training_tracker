{% extends 'base.html' %}
{% block content %}
<h1>–û—Ç—á–µ—Ç –ø–æ –æ–±—É—á–µ–Ω–∏—é</h1>
<div class="filters-container">
    <form class="filter-form" method="get">
        <div class="form-group">
            <label for="employees"><span class="icon">üë§</span> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</label>
            <select name="employees" id="employees" class="form-input" multiple>
                {% for employee in employees %}
                <option value="{{ employee.pk }}"
                        {% if employee.pk|stringformat:"s" in selected_employees %}selected{% endif %}>
                    {{ employee.last_name }} {{ employee.first_name.0 }}. {{ employee.middle_name.0|default:"" }}.
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="program"><span class="icon">üìö</span> –ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±—É—á–µ–Ω–∏—è:</label>
            <select name="program" id="program" class="form-input">
                <option value="">–í—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</option>
                {% for program in training_programs %}
                <option value="{{ program.pk }}"
                        {% if selected_program == program.pk|stringformat:"s" %}selected{% endif %}>
                    {{ program.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group form-checkbox">
            <label for="exclude_not_completed"><span class="icon">‚úîÔ∏è</span> –ò—Å–∫–ª—é—á–∏—Ç—å –Ω–µ–ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ:</label>
            <input type="checkbox" name="exclude_not_completed" id="exclude_not_completed"
                   {% if exclude_not_completed %}checked{% endif %}>
        </div>
        <div class="buttons-group">
            <button type="submit" class="button button--primary"><span class="icon">üîç</span> –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
            <a href="{% url 'reports:report_list' %}" class="button button--danger"><span class="icon">‚úñÔ∏è</span> –°–±—Ä–æ—Å–∏—Ç—å</a>
            <a href="{% url 'reports:export_report' %}?employees={{ selected_employees|join:'&employees=' }}&program={{ selected_program|default:'' }}&exclude_not_completed={{ exclude_not_completed|yesno:'on,' }}"
               class="button button--info"><span class="icon">üì§</span> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
        </div>
    </form>
</div>
<div class="legend">
    <span class="legend-item completed"><span class="icon">‚úÖ</span> –ü—Ä–æ–π–¥–µ–Ω–æ</span>
    <span class="legend-item warning"><span class="icon">‚ö†Ô∏è</span> –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ</span>
    <span class="legend-item overdue"><span class="icon">‚è∞</span> –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
    <span class="legend-item not-completed"><span class="icon">‚ùå</span> –ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ</span>
</div>
<div class="table-container">
    <table class="report-table">
        <thead>
            <tr>
                <th class="sortable">
                    <a href="?sort_by=last_name&sort_order={% if sort_by == 'last_name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&employees={{ selected_employees|join:'&employees=' }}&program={{ selected_program|default:'' }}&exclude_not_completed={{ exclude_not_completed|yesno:'on,' }}"
                       class="sort-icon {% if sort_by == 'last_name' %}{{ sort_order }}{% endif %}">
                        –°–æ—Ç—Ä—É–¥–Ω–∏–∫
                    </a>
                </th>
                <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                <th>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
                <th>–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–±–æ—Ç–Ω–∏–∫</th>
                <th>–ß–ª–µ–Ω –∫–æ–º–∏—Å—Å–∏–∏ –ø–æ –û–¢</th>
                <th>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                {% if selected_program %}
                <th class="sortable">
                    <a href="?sort_by={{ selected_program }}&sort_order={% if sort_by == selected_program and sort_order == 'asc' %}desc{% else %}asc{% endif %}&employees={{ selected_employees|join:'&employees=' }}&program={{ selected_program|default:'' }}&exclude_not_completed={{ exclude_not_completed|yesno:'on,' }}"
                       class="sort-icon {% if sort_by == selected_program %}{{ sort_order }}{% endif %}">
                        {{ selected_program_name }}
                    </a>
                </th>
                <th>–°—Ç–∞—Ç—É—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</th>
                {% else %}
                {% for program in training_programs %}
                <th class="sortable">
                    <a href="?sort_by={{ program.pk }}&sort_order={% if sort_by == program.pk|stringformat:'s' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&employees={{ selected_employees|join:'&employees=' }}&program={{ selected_program|default:'' }}&exclude_not_completed={{ exclude_not_completed|yesno:'on,' }}"
                       class="sort-icon {% if sort_by == program.pk|stringformat:'s' %}{{ sort_order }}{% endif %}">
                        {{ program.name }}
                    </a>
                </th>
                <th>–°—Ç–∞—Ç—É—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</th>
                {% endfor %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for data in report_data %}
            <tr>
                <td>{{ data.employee.last_name }} {{ data.employee.first_name.0 }}. {{ data.employee.middle_name.0|default:"" }}.</td>
                <td>{{ data.employee.position|default:"‚Äî" }}</td>
                <td>{{ data.employee.position.is_manager|yesno:"–î–∞,–ù–µ—Ç" }}</td>
                <td>{{ data.employee.position.is_teacher|yesno:"–î–∞,–ù–µ—Ç" }}</td>
                <td>{{ data.employee.is_safety_commission_member|yesno:"–î–∞,–ù–µ—Ç" }}</td>
                <td>{{ data.employee.department|default:"‚Äî" }}</td>
                {% if selected_program %}
                <td class="{{ data.trainings|get_item:selected_program|dict_get:'class' }}">
                    {{ data.trainings|get_item:selected_program|dict_get:'date'|default:"–û–±—É—á–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ" }}
                </td>
                <td>
                    {% if data.trainings|get_item:selected_program|dict_get:'is_verified' %}
                        –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                    {% else %}
                        –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                    {% endif %}
                </td>
                {% else %}
                {% for program in training_programs %}
                <td class="{{ data.trainings|get_item:program.id|dict_get:'class' }}">
                    {{ data.trainings|get_item:program.id|dict_get:'date'|default:"–û–±—É—á–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ" }}
                </td>
                <td>
                    {% if data.trainings|get_item:program.id|dict_get:'is_verified' %}
                        –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                    {% else %}
                        –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                    {% endif %}
                </td>
                {% endfor %}
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{% if selected_program %}8{% else %}{{ training_programs|length|add:6|add:training_programs|length }}{% endif %}">
                    –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if is_paginated %}
<ul class="pagination">
    {% if page_obj.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&employees={{ selected_employees|join:'&employees=' }}&program={{ selected_program|default:'' }}&exclude_not_completed={{ exclude_not_completed|yesno:'on,' }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
    </li>
    {% else %}
    <li class="page-item disabled">
        <span class="page-link">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
    </li>
    {% endif %}
    {% for num in paginator.page_range %}
    {% if page_obj.number == num %}
    <li class="page-item active" aria-current="page">
        <span class="page-link">{{ num }}</span>
    </li>
    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
    <li class="page-item">
        <a class="page-link" href="?page={{ num }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&employees={{ selected_employees|join:'&employees=' }}&program={{ selected_program|default:'' }}&exclude_not_completed={{ exclude_not_completed|yesno:'on,' }}">{{ num }}</a>
    </li>
    {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
    <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&employees={{ selected_employees|join:'&employees=' }}&program={{ selected_program|default:'' }}&exclude_not_completed={{ exclude_not_completed|yesno:'on,' }}">–°–ª–µ–¥—É—é—â–∞—è</a>
    </li>
    {% else %}
    <li class="page-item disabled">
        <span class="page-link">–°–ª–µ–¥—É—é—â–∞—è</span>
    </li>
    {% endif %}
</ul>
{% endif %}
<div>
    <p><strong>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:</strong> {{ total_employees }}</p>
    {% for program_name, count in trained_counts.items %}
    <p><strong>{{ program_name }}:</strong> {{ count }} —á–µ–ª.</p>
    {% endfor %}
</div>
{% endblock %}